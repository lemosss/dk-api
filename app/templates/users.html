{% extends "base.html" %}

{% block title %}Usuários - DK Invoice Calendar{% endblock %}

{% block body %}
<div id="app">
  {% include "components/sidebar.html" %}
  
  <main class="main-content">
    <div class="page-header">
      <div>
        <h1 class="page-title">Usuários</h1>
        <p class="page-subtitle">Gerencie os usuários do sistema</p>
      </div>
      <button class="btn btn-primary" @click="openCreateModal">
        <i data-lucide="plus" style="width: 18px; height: 18px;"></i>
        Novo Usuário
      </button>
    </div>
    
    <!-- Users Table -->
    <div class="card" style="padding: 0;">
      <div v-if="loading" class="empty-state">
        <div class="spinner" style="width: 32px; height: 32px;"></div>
      </div>
      
      <div v-else-if="users.length === 0" class="empty-state">
        <i data-lucide="users" class="empty-state-icon"></i>
        <div class="empty-state-title">Nenhum usuário encontrado</div>
      </div>
      
      <div v-else class="table-container" style="border: none;">
        <table class="table">
          <thead>
            <tr>
              <th>Usuário</th>
              <th>Perfil</th>
              <th>Empresa</th>
              <th>Status</th>
              <th>Criado em</th>
              <th style="width: 100px;">Ações</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="u in users" :key="u.id">
              <td>
                <div class="flex items-center gap-md">
                  <div class="user-avatar" style="width: 32px; height: 32px; font-size: 0.75rem;">
                    [[ u.email.charAt(0).toUpperCase() ]]
                  </div>
                  <div>
                    <div style="font-weight: 500;">[[ u.name || u.email ]]</div>
                    <div class="text-muted" style="font-size: 0.75rem;">[[ u.email ]]</div>
                  </div>
                </div>
              </td>
              <td>
                <span class="badge" :class="getRoleBadge(u.role)">[[ getRoleLabel(u.role) ]]</span>
              </td>
              <td>[[ getCompanyName(u.company_id) ]]</td>
              <td>
                <span class="badge" :class="u.is_active ? 'badge-success' : 'badge-danger'">
                  [[ u.is_active ? 'Ativo' : 'Inativo' ]]
                </span>
              </td>
              <td>[[ formatDate(u.created_at) ]]</td>
              <td>
                <div class="flex gap-xs">
                  <button class="btn btn-icon btn-ghost" title="Editar" @click="openEditModal(u)">
                    <i data-lucide="pencil" style="width: 16px; height: 16px;"></i>
                  </button>
                  <button class="btn btn-icon btn-ghost" title="Excluir" @click="confirmDelete(u)" v-if="u.id !== user.id">
                    <i data-lucide="trash-2" style="width: 16px; height: 16px;"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>
  
  <!-- Create/Edit Modal -->
  <div class="modal-overlay" :class="{ active: showModal }" @click.self="closeModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">[[ editingUser ? 'Editar Usuário' : 'Novo Usuário' ]]</h3>
        <button class="btn btn-icon btn-ghost" @click="closeModal">
          <i data-lucide="x" style="width: 20px; height: 20px;"></i>
        </button>
      </div>
      <div class="modal-body">
        <form @submit.prevent="saveUser">
          <div class="form-group">
            <label class="form-label">Nome</label>
            <input type="text" class="form-input" v-model="form.name" placeholder="Nome completo">
          </div>
          
          <div class="form-group">
            <label class="form-label">Email *</label>
            <input type="email" class="form-input" v-model="form.email" required placeholder="email@exemplo.com">
          </div>
          
          <div class="form-group" v-if="!editingUser">
            <label class="form-label">Senha *</label>
            <input type="password" class="form-input" v-model="form.password" required placeholder="Mínimo 6 caracteres" minlength="6">
          </div>
          
          <div class="form-group">
            <label class="form-label">Perfil *</label>
            <select class="form-select" v-model="form.role" required>
              <option value="user">Usuário</option>
              <option value="admin">Administrador</option>
              <option value="superadmin">Super Admin</option>
            </select>
          </div>
          
          <div class="form-group" v-if="form.role === 'user'">
            <label class="form-label">Empresa *</label>
            <select class="form-select" v-model="form.company_id" :required="form.role === 'user'">
              <option :value="null" disabled>Selecione uma empresa</option>
              <option v-for="company in companies" :key="company.id" :value="company.id">
                [[ company.name ]]
              </option>
            </select>
          </div>
          
          <div class="form-group" v-if="editingUser">
            <label class="form-label">Status</label>
            <select class="form-select" v-model="form.is_active">
              <option :value="true">Ativo</option>
              <option :value="false">Inativo</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" @click="closeModal">Cancelar</button>
        <button class="btn btn-primary" @click="saveUser" :disabled="saving">
          <span v-if="saving" class="spinner"></span>
          <span v-else>[[ editingUser ? 'Salvar' : 'Criar' ]]</span>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Delete Confirmation Modal -->
  <div class="modal-overlay" :class="{ active: showDeleteModal }" @click.self="showDeleteModal = false">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <h3 class="modal-title">Confirmar exclusão</h3>
        <button class="btn btn-icon btn-ghost" @click="showDeleteModal = false">
          <i data-lucide="x" style="width: 20px; height: 20px;"></i>
        </button>
      </div>
      <div class="modal-body">
        <p>Tem certeza que deseja excluir este usuário?</p>
        <p class="text-muted" style="margin-top: 8px;">[[ deletingUser?.email ]]</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" @click="showDeleteModal = false">Cancelar</button>
        <button class="btn btn-danger" @click="deleteUser" :disabled="deleting">
          <span v-if="deleting" class="spinner"></span>
          <span v-else>Excluir</span>
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const { createApp } = Vue;

createApp({
  delimiters: ['[[', ']]'],
  data() {
    return {
      user: null,
      currentPage: 'users',
      sidebarOpen: false,
      showUserMenu: false,
      users: [],
      companies: [],
      loading: true,
      showModal: false,
      showDeleteModal: false,
      editingUser: null,
      deletingUser: null,
      saving: false,
      deleting: false,
      form: {
        name: '',
        email: '',
        password: '',
        role: 'user',
        company_id: null,
        is_active: true
      }
    };
  },
  methods: {
    formatDate(date) {
      return window.formatDate(date);
    },
    getRoleBadge(role) {
      const badges = {
        superadmin: 'badge-danger',
        admin: 'badge-warning',
        user: 'badge-info'
      };
      return badges[role] || 'badge-info';
    },
    getRoleLabel(role) {
      const labels = {
        superadmin: 'Super Admin',
        admin: 'Admin',
        user: 'Usuário'
      };
      return labels[role] || role;
    },
    getCompanyName(companyId) {
      if (!companyId) return '-';
      const company = this.companies.find(c => c.id === companyId);
      return company ? company.name : '-';
    },
    async loadUsers() {
      this.loading = true;
      try {
        this.users = await api('/api/users');
      } catch (err) {
        showToast(err.message, 'error');
      } finally {
        this.loading = false;
        this.$nextTick(() => lucide.createIcons());
      }
    },
    async loadCompanies() {
      try {
        this.companies = await api('/api/companies');
      } catch (err) {
        console.error(err);
      }
    },
    openCreateModal() {
      this.editingUser = null;
      this.form = {
        name: '',
        email: '',
        password: '',
        role: 'user',
        company_id: null,
        is_active: true
      };
      this.showModal = true;
      this.$nextTick(() => lucide.createIcons());
    },
    openEditModal(u) {
      this.editingUser = u;
      this.form = {
        name: u.name || '',
        email: u.email,
        password: '',
        role: u.role,
        company_id: u.company_id,
        is_active: u.is_active
      };
      this.showModal = true;
      this.$nextTick(() => lucide.createIcons());
    },
    closeModal() {
      this.showModal = false;
      this.editingUser = null;
    },
    async saveUser() {
      this.saving = true;
      try {
        if (this.editingUser) {
          const payload = {
            name: this.form.name,
            email: this.form.email,
            role: this.form.role,
            company_id: this.form.role === 'user' ? this.form.company_id : null,
            is_active: this.form.is_active
          };
          await api(`/api/users/${this.editingUser.id}`, {
            method: 'PUT',
            body: JSON.stringify(payload)
          });
          showToast('Usuário atualizado com sucesso');
        } else {
          const payload = {
            name: this.form.name,
            email: this.form.email,
            password: this.form.password,
            role: this.form.role,
            company_id: this.form.role === 'user' ? this.form.company_id : null
          };
          await api('/api/users', {
            method: 'POST',
            body: JSON.stringify(payload)
          });
          showToast('Usuário criado com sucesso');
        }
        
        this.closeModal();
        await this.loadUsers();
      } catch (err) {
        showToast(err.message, 'error');
      } finally {
        this.saving = false;
      }
    },
    confirmDelete(u) {
      this.deletingUser = u;
      this.showDeleteModal = true;
      this.$nextTick(() => lucide.createIcons());
    },
    async deleteUser() {
      this.deleting = true;
      try {
        await api(`/api/users/${this.deletingUser.id}`, { method: 'DELETE' });
        showToast('Usuário excluído com sucesso');
        this.showDeleteModal = false;
        this.deletingUser = null;
        await this.loadUsers();
      } catch (err) {
        showToast(err.message, 'error');
      } finally {
        this.deleting = false;
      }
    },
    toggleUserMenu() {
      this.showUserMenu = !this.showUserMenu;
    },
    logout() {
      localStorage.removeItem('token');
      window.location.href = '/login';
    },
    async loadUser() {
      try {
        this.user = await api('/api/auth/me');
      } catch (err) {
        console.error(err);
      }
    }
  },
  async mounted() {
    if (!localStorage.getItem('token')) {
      window.location.href = '/login';
      return;
    }
    await this.loadUser();
    await this.loadCompanies();
    await this.loadUsers();
    this.$nextTick(() => lucide.createIcons());
  }
}).mount('#app');
</script>
{% endblock %}
