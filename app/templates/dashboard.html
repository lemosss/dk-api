{% extends "base.html" %}

{% block title %}Dashboard - DK Invoice Calendar{% endblock %}

{% block body %}
<div id="app">
  {% include "components/sidebar.html" %}
  
  <main class="main-content">
    <div class="page-header">
      <div>
        <h1 class="page-title">Dashboard</h1>
        <p class="page-subtitle">Visão geral das suas faturas</p>
      </div>
      <div class="flex gap-sm">
        <button class="btn btn-primary" @click="goToCalendar">
          <i data-lucide="calendar" style="width: 18px; height: 18px;"></i>
          Ver Calendário
        </button>
      </div>
    </div>
    
    <!-- Stats Cards -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon primary">
          <i data-lucide="file-text" style="width: 24px; height: 24px;"></i>
        </div>
        <div>
          <div class="stat-value">[[ stats.total ]]</div>
          <div class="stat-label">Total de Faturas</div>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon success">
          <i data-lucide="check-circle" style="width: 24px; height: 24px;"></i>
        </div>
        <div>
          <div class="stat-value">[[ stats.paid ]]</div>
          <div class="stat-label">Pagas</div>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon warning">
          <i data-lucide="clock" style="width: 24px; height: 24px;"></i>
        </div>
        <div>
          <div class="stat-value">[[ stats.pending ]]</div>
          <div class="stat-label">Pendentes</div>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon danger">
          <i data-lucide="alert-circle" style="width: 24px; height: 24px;"></i>
        </div>
        <div>
          <div class="stat-value">[[ stats.overdue ]]</div>
          <div class="stat-label">Vencidas</div>
        </div>
      </div>
    </div>
    
    <!-- Additional Stats -->
    <div class="stats-grid" style="margin-top: var(--spacing-lg);">
      <div class="stat-card">
        <div class="stat-icon warning">
          <i data-lucide="calendar-clock" style="width: 24px; height: 24px;"></i>
        </div>
        <div>
          <div class="stat-value">[[ stats.upcoming ]]</div>
          <div class="stat-label">Próximos 7 dias</div>
        </div>
      </div>
      
      <div class="stat-card" style="grid-column: span 2;">
        <div class="stat-icon primary">
          <i data-lucide="wallet" style="width: 24px; height: 24px;"></i>
        </div>
        <div>
          <div class="stat-value">[[ formatCurrency(stats.pending_amount) ]]</div>
          <div class="stat-label">Valor Pendente Total</div>
        </div>
      </div>
    </div>
    
    <!-- Recent Invoices -->
    <div class="card" style="margin-top: var(--spacing-xl);">
      <div class="card-header">
        <h3 class="card-title">Faturas Recentes</h3>
        <a href="/invoices" class="btn btn-ghost btn-sm">
          Ver todas
          <i data-lucide="arrow-right" style="width: 16px; height: 16px;"></i>
        </a>
      </div>
      
      <div v-if="recentInvoices.length === 0" class="empty-state">
        <i data-lucide="inbox" class="empty-state-icon"></i>
        <div class="empty-state-title">Nenhuma fatura encontrada</div>
        <p>Crie sua primeira fatura para começar</p>
      </div>
      
      <div v-else class="table-container" style="border: none;">
        <table class="table">
          <thead>
            <tr>
              <th>Descrição</th>
              <th>Empresa</th>
              <th>Vencimento</th>
              <th>Valor</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="invoice in recentInvoices" :key="invoice.id">
              <td>[[ invoice.description ]]</td>
              <td>[[ invoice.company_name ]]</td>
              <td>[[ formatDate(invoice.due_date) ]]</td>
              <td>[[ formatCurrency(invoice.amount) ]]</td>
              <td>
                <span class="badge" :class="getStatusClass(invoice)">[[ getStatusText(invoice) ]]</span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>
</div>
{% endblock %}

{% block scripts %}
<script>
const { createApp } = Vue;

createApp({
  delimiters: ['[[', ']]'],
  data() {
    return {
      user: null,
      currentPage: 'dashboard',
      sidebarOpen: false,
      showUserMenu: false,
      stats: {
        total: 0,
        paid: 0,
        pending: 0,
        overdue: 0,
        upcoming: 0,
        pending_amount: 0
      },
      recentInvoices: []
    };
  },
  methods: {
    formatCurrency(value) {
      return window.formatCurrency(value);
    },
    formatDate(date) {
      return window.formatDate(date);
    },
    getStatusClass(invoice) {
      if (invoice.is_paid) return 'badge-success';
      const dueDate = new Date(invoice.due_date);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      if (dueDate < today) return 'badge-danger';
      return 'badge-warning';
    },
    getStatusText(invoice) {
      if (invoice.is_paid) return 'Paga';
      const dueDate = new Date(invoice.due_date);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      if (dueDate < today) return 'Vencida';
      return 'Pendente';
    },
    goToCalendar() {
      window.location.href = '/calendar';
    },
    toggleUserMenu() {
      this.showUserMenu = !this.showUserMenu;
    },
    logout() {
      localStorage.removeItem('token');
      window.location.href = '/login';
    },
    async loadData() {
      try {
        this.user = await api('/api/auth/me');
        this.stats = await api('/api/auth/stats');
        this.recentInvoices = await api('/api/invoices?limit=5');
      } catch (err) {
        console.error(err);
      }
    }
  },
  mounted() {
    if (!localStorage.getItem('token')) {
      window.location.href = '/login';
      return;
    }
    this.loadData();
    this.$nextTick(() => lucide.createIcons());
  }
}).mount('#app');
</script>
{% endblock %}
