{% extends "base.html" %}

{% block title %}Faturas - DK Invoice Calendar{% endblock %}

{% block body %}
<div id="app">
  {% include "components/sidebar.html" %}
  
  <main class="main-content">
    <div class="page-header">
      <div>
        <h1 class="page-title">Faturas</h1>
        <p class="page-subtitle">Gerencie todas as suas faturas</p>
      </div>
      <button class="btn btn-primary" @click="openCreateModal" v-if="user && user.role !== 'user'">
        <i data-lucide="plus" style="width: 18px; height: 18px;"></i>
        Nova Fatura
      </button>
    </div>
    
    <!-- Filters -->
    <div class="card" style="padding: var(--spacing-md); margin-bottom: var(--spacing-lg);">
      <div class="flex gap-md" style="flex-wrap: wrap;">
        <select class="filter-select" v-model="filters.company" @change="loadInvoices" v-if="user && user.role !== 'user'">
          <option :value="null">Todas as empresas</option>
          <option v-for="company in companies" :key="company.id" :value="company.id">
            [[ company.name ]]
          </option>
        </select>
        <select class="filter-select" v-model="filters.status" @change="loadInvoices">
          <option :value="null">Todos os status</option>
          <option value="pending">Pendentes</option>
          <option value="paid">Pagas</option>
        </select>
        <select class="filter-select" v-model="filters.month" @change="loadInvoices">
          <option :value="null">Todos os meses</option>
          <option v-for="(name, index) in months" :key="index" :value="index + 1">
            [[ name ]]
          </option>
        </select>
      </div>
    </div>
    
    <!-- Invoices Table -->
    <div class="card" style="padding: 0;">
      <div v-if="loading" class="empty-state">
        <div class="spinner" style="width: 32px; height: 32px;"></div>
      </div>
      
      <div v-else-if="invoices.length === 0" class="empty-state">
        <i data-lucide="inbox" class="empty-state-icon"></i>
        <div class="empty-state-title">Nenhuma fatura encontrada</div>
        <p>Tente ajustar os filtros ou crie uma nova fatura</p>
      </div>
      
      <div v-else class="table-container" style="border: none;">
        <table class="table">
          <thead>
            <tr>
              <th>Descrição</th>
              <th>Empresa</th>
              <th>Vencimento</th>
              <th>Valor</th>
              <th>Status</th>
              <th style="width: 120px;">Ações</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="invoice in invoices" :key="invoice.id">
              <td>
                <div style="font-weight: 500;">[[ invoice.description ]]</div>
                <div style="font-size: 0.75rem; color: var(--text-muted);" v-if="invoice.notes">
                  [[ invoice.notes ]]
                </div>
              </td>
              <td>[[ invoice.company_name ]]</td>
              <td>[[ formatDate(invoice.due_date) ]]</td>
              <td style="font-weight: 600;">[[ formatCurrency(invoice.amount) ]]</td>
              <td>
                <span class="badge" :class="getStatusClass(invoice)">[[ getStatusText(invoice) ]]</span>
              </td>
              <td>
                <div class="flex gap-xs">
                  <a 
                    v-if="invoice.file_url" 
                    :href="invoice.file_url" 
                    target="_blank"
                    class="btn btn-icon btn-ghost" 
                    title="Ver Boleto (PDF)"
                    style="color: var(--primary);"
                  >
                    <i data-lucide="file-text" style="width: 16px; height: 16px;"></i>
                  </a>
                  <button class="btn btn-icon btn-ghost" title="Editar" @click="openEditModal(invoice)" v-if="user && user.role !== 'user'">
                    <i data-lucide="pencil" style="width: 16px; height: 16px;"></i>
                  </button>
                  <button 
                    class="btn btn-icon btn-ghost" 
                    :title="invoice.is_paid ? 'Marcar como não paga' : 'Marcar como paga'"
                    @click="togglePaid(invoice)"
                  >
                    <i :data-lucide="invoice.is_paid ? 'x-circle' : 'check-circle'" style="width: 16px; height: 16px;"></i>
                  </button>
                  <button class="btn btn-icon btn-ghost" title="Excluir" @click="confirmDelete(invoice)" v-if="user && user.role !== 'user'">
                    <i data-lucide="trash-2" style="width: 16px; height: 16px;"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>
  
  <!-- Create/Edit Modal -->
  <div class="modal-overlay" :class="{ active: showModal }" @click.self="closeModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">[[ editingInvoice ? 'Editar Fatura' : 'Nova Fatura' ]]</h3>
        <button class="btn btn-icon btn-ghost" @click="closeModal">
          <i data-lucide="x" style="width: 20px; height: 20px;"></i>
        </button>
      </div>
      <div class="modal-body">
        <form @submit.prevent="saveInvoice">
          <div class="form-group">
            <label class="form-label">Empresa *</label>
            <select class="form-select" v-model="form.company_id" required>
              <option :value="null" disabled>Selecione uma empresa</option>
              <option v-for="company in companies" :key="company.id" :value="company.id">
                [[ company.name ]]
              </option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">Descrição *</label>
            <input type="text" class="form-input" v-model="form.description" required placeholder="Ex: Fatura de serviços">
          </div>
          
          <div class="form-group">
            <label class="form-label">Valor *</label>
            <input type="number" step="0.01" min="0" class="form-input" v-model="form.amount" required placeholder="0.00">
          </div>
          
          <div class="form-group">
            <label class="form-label">Vencimento *</label>
            <input type="date" class="form-input" v-model="form.due_date" required>
          </div>
          
          <div class="form-group">
            <label class="form-label">Boleto (PDF)</label>
            <div v-if="editingInvoice && editingInvoice.file_url" class="flex gap-sm" style="margin-bottom: 8px;">
              <a :href="editingInvoice.file_url" target="_blank" class="btn btn-secondary btn-sm">
                <i data-lucide="file-text" style="width: 16px; height: 16px;"></i>
                Ver PDF atual
              </a>
              <button type="button" class="btn btn-danger btn-sm" @click="removeFile" :disabled="removingFile">
                <i data-lucide="trash-2" style="width: 16px; height: 16px;"></i>
                Remover
              </button>
            </div>
            <input 
              type="file" 
              class="form-input" 
              accept=".pdf" 
              ref="fileInput"
              @change="handleFileSelect"
              style="padding: 8px;"
            >
            <small class="text-muted">Apenas arquivos PDF são aceitos</small>
          </div>
          
          <div class="form-group">
            <label class="form-label">Observações (opcional)</label>
            <textarea class="form-textarea" v-model="form.notes" placeholder="Anotações sobre a fatura"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" @click="closeModal">Cancelar</button>
        <button class="btn btn-primary" @click="saveInvoice" :disabled="saving">
          <span v-if="saving" class="spinner"></span>
          <span v-else>[[ editingInvoice ? 'Salvar' : 'Criar' ]]</span>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Delete Confirmation Modal -->
  <div class="modal-overlay" :class="{ active: showDeleteModal }" @click.self="showDeleteModal = false">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <h3 class="modal-title">Confirmar exclusão</h3>
        <button class="btn btn-icon btn-ghost" @click="showDeleteModal = false">
          <i data-lucide="x" style="width: 20px; height: 20px;"></i>
        </button>
      </div>
      <div class="modal-body">
        <p>Tem certeza que deseja excluir esta fatura?</p>
        <p class="text-muted" style="margin-top: 8px;">[[ deletingInvoice?.description ]]</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" @click="showDeleteModal = false">Cancelar</button>
        <button class="btn btn-danger" @click="deleteInvoice" :disabled="deleting">
          <span v-if="deleting" class="spinner"></span>
          <span v-else>Excluir</span>
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const { createApp } = Vue;

createApp({
  delimiters: ['[[', ']]'],
  data() {
    return {
      user: null,
      currentPage: 'invoices',
      sidebarOpen: false,
      showUserMenu: false,
      companies: [],
      invoices: [],
      loading: true,
      filters: {
        company: null,
        status: null,
        month: null
      },
      months: ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 
               'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'],
      showModal: false,
      showDeleteModal: false,
      editingInvoice: null,
      deletingInvoice: null,
      saving: false,
      deleting: false,
      removingFile: false,
      selectedFile: null,
      form: {
        company_id: null,
        description: '',
        amount: '',
        due_date: '',
        notes: ''
      }
    };
  },
  methods: {
    formatCurrency(value) {
      return window.formatCurrency(value);
    },
    formatDate(date) {
      return window.formatDate(date);
    },
    getStatusClass(invoice) {
      if (invoice.is_paid) return 'badge-success';
      const dueDate = new Date(invoice.due_date);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      if (dueDate < today) return 'badge-danger';
      return 'badge-warning';
    },
    getStatusText(invoice) {
      if (invoice.is_paid) return 'Paga';
      const dueDate = new Date(invoice.due_date);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      if (dueDate < today) return 'Vencida';
      return 'Pendente';
    },
    async loadInvoices() {
      this.loading = true;
      try {
        let url = '/api/invoices?';
        const params = [];
        if (this.filters.company) params.push(`company_id=${this.filters.company}`);
        if (this.filters.status === 'paid') params.push('is_paid=true');
        else if (this.filters.status === 'pending') params.push('is_paid=false');
        if (this.filters.month) {
          params.push(`month=${this.filters.month}`);
          params.push(`year=${new Date().getFullYear()}`);
        }
        this.invoices = await api(url + params.join('&'));
      } catch (err) {
        showToast(err.message, 'error');
      } finally {
        this.loading = false;
        this.$nextTick(() => lucide.createIcons());
      }
    },
    async loadCompanies() {
      try {
        this.companies = await api('/api/companies');
      } catch (err) {
        console.error(err);
      }
    },
    openCreateModal() {
      this.editingInvoice = null;
      this.selectedFile = null;
      this.form = {
        company_id: null,
        description: '',
        amount: '',
        due_date: '',
        notes: ''
      };
      this.showModal = true;
      this.$nextTick(() => {
        lucide.createIcons();
        if (this.$refs.fileInput) this.$refs.fileInput.value = '';
      });
    },
    openEditModal(invoice) {
      this.editingInvoice = invoice;
      this.selectedFile = null;
      this.form = {
        company_id: invoice.company_id,
        description: invoice.description,
        amount: invoice.amount,
        due_date: invoice.due_date,
        notes: invoice.notes || ''
      };
      this.showModal = true;
      this.$nextTick(() => {
        lucide.createIcons();
        if (this.$refs.fileInput) this.$refs.fileInput.value = '';
      });
    },
    closeModal() {
      this.showModal = false;
      this.editingInvoice = null;
      this.selectedFile = null;
    },
    handleFileSelect(event) {
      const file = event.target.files[0];
      if (file && file.type === 'application/pdf') {
        this.selectedFile = file;
      } else if (file) {
        showToast('Apenas arquivos PDF são permitidos', 'error');
        event.target.value = '';
        this.selectedFile = null;
      }
    },
    async uploadFile(invoiceId) {
      if (!this.selectedFile) return;
      
      const formData = new FormData();
      formData.append('file', this.selectedFile);
      
      const token = localStorage.getItem('token');
      const response = await fetch(`/api/invoices/${invoiceId}/upload`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`
        },
        body: formData
      });
      
      if (!response.ok) {
        const error = await response.json().catch(() => ({}));
        throw new Error(error.detail || 'Erro ao fazer upload');
      }
      
      return response.json();
    },
    async removeFile() {
      if (!this.editingInvoice) return;
      this.removingFile = true;
      try {
        await api(`/api/invoices/${this.editingInvoice.id}/file`, { method: 'DELETE' });
        this.editingInvoice.file_url = null;
        showToast('Arquivo removido com sucesso');
        await this.loadInvoices();
      } catch (err) {
        showToast(err.message, 'error');
      } finally {
        this.removingFile = false;
      }
    },
    async saveInvoice() {
      this.saving = true;
      try {
        const payload = {
          ...this.form,
          amount: parseFloat(this.form.amount)
        };
        
        let invoiceId;
        
        if (this.editingInvoice) {
          await api(`/api/invoices/${this.editingInvoice.id}`, {
            method: 'PUT',
            body: JSON.stringify(payload)
          });
          invoiceId = this.editingInvoice.id;
          showToast('Fatura atualizada com sucesso');
        } else {
          const result = await api('/api/invoices', {
            method: 'POST',
            body: JSON.stringify(payload)
          });
          invoiceId = result.id;
          showToast('Fatura criada com sucesso');
        }
        
        // Upload do arquivo se houver
        if (this.selectedFile && invoiceId) {
          try {
            await this.uploadFile(invoiceId);
            showToast('Boleto anexado com sucesso');
          } catch (err) {
            showToast('Fatura salva, mas erro no upload: ' + err.message, 'warning');
          }
        }
        
        this.closeModal();
        await this.loadInvoices();
      } catch (err) {
        showToast(err.message, 'error');
      } finally {
        this.saving = false;
      }
    },
    async togglePaid(invoice) {
      try {
        const wasPaid = invoice.is_paid;
        await api(`/api/invoices/${invoice.id}/toggle-paid`, { method: 'PATCH' });
        if (wasPaid) {
          // Verifica se está vencida
          const dueDate = new Date(invoice.due_date);
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          if (dueDate < today) {
            showToast('Fatura marcada como não paga', 'error');
          } else {
            showToast('Fatura marcada como não paga', 'warning');
          }
        } else {
          showToast('Fatura marcada como paga', 'success');
        }
        await this.loadInvoices();
      } catch (err) {
        showToast(err.message, 'error');
      }
    },
    confirmDelete(invoice) {
      this.deletingInvoice = invoice;
      this.showDeleteModal = true;
      this.$nextTick(() => lucide.createIcons());
    },
    async deleteInvoice() {
      this.deleting = true;
      try {
        await api(`/api/invoices/${this.deletingInvoice.id}`, { method: 'DELETE' });
        showToast('Fatura excluída com sucesso');
        this.showDeleteModal = false;
        this.deletingInvoice = null;
        await this.loadInvoices();
      } catch (err) {
        showToast(err.message, 'error');
      } finally {
        this.deleting = false;
      }
    },
    toggleUserMenu() {
      this.showUserMenu = !this.showUserMenu;
    },
    logout() {
      localStorage.removeItem('token');
      window.location.href = '/login';
    },
    async loadUser() {
      try {
        this.user = await api('/api/auth/me');
        if (this.user.role === 'user') {
          this.filters.company = this.user.company_id;
        }
      } catch (err) {
        console.error(err);
      }
    }
  },
  async mounted() {
    if (!localStorage.getItem('token')) {
      window.location.href = '/login';
      return;
    }
    await this.loadUser();
    await this.loadCompanies();
    await this.loadInvoices();
    this.$nextTick(() => lucide.createIcons());
  }
}).mount('#app');
</script>
{% endblock %}
