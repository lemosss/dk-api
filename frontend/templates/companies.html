{% extends "base.html" %}

{% block title %}Empresas - DK Invoice Calendar{% endblock %}

{% block body %}
<div id="app">
  {% include "components/sidebar.html" %}
  
  <main class="main-content">
    <div class="page-header">
      <div>
        <h1 class="page-title">Empresas</h1>
        <p class="page-subtitle">Gerencie as empresas cadastradas</p>
      </div>
      <button class="btn btn-primary" @click="openCreateModal">
        <i data-lucide="plus" style="width: 18px; height: 18px;"></i>
        Nova Empresa
      </button>
    </div>
    
    <!-- Companies Grid -->
    <div v-if="loading" class="empty-state">
      <div class="spinner" style="width: 32px; height: 32px;"></div>
    </div>
    
    <div v-else-if="companies.length === 0" class="empty-state">
      <i data-lucide="building-2" class="empty-state-icon"></i>
      <div class="empty-state-title">Nenhuma empresa cadastrada</div>
      <p>Crie a primeira empresa para começar</p>
    </div>
    
    <div v-else class="stats-grid" style="grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));">
      <div class="card" v-for="company in companies" :key="company.id">
        <div class="flex justify-between items-center mb-md">
          <div class="flex items-center gap-md">
            <div class="stat-icon primary">
              <i data-lucide="building-2" style="width: 24px; height: 24px;"></i>
            </div>
            <div>
              <h3 style="font-size: 1rem; font-weight: 600;">[[ company.name ]]</h3>
              <p class="text-muted" style="font-size: 0.75rem;">[[ company.cnpj ]]</p>
            </div>
          </div>
          <span class="badge" :class="company.is_active ? 'badge-success' : 'badge-danger'">
            [[ company.is_active ? 'Ativa' : 'Inativa' ]]
          </span>
        </div>
        
        <div style="font-size: 0.875rem; color: var(--text-secondary);">
          <div v-if="company.email" class="flex items-center gap-sm mb-sm">
            <i data-lucide="mail" style="width: 14px; height: 14px;"></i>
            [[ company.email ]]
          </div>
          <div v-if="company.phone" class="flex items-center gap-sm mb-sm">
            <i data-lucide="phone" style="width: 14px; height: 14px;"></i>
            [[ company.phone ]]
          </div>
          <div v-if="company.address" class="flex items-center gap-sm">
            <i data-lucide="map-pin" style="width: 14px; height: 14px;"></i>
            [[ company.address ]]
          </div>
        </div>
        
        <div class="flex justify-between items-center" style="margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--border-color);">
          <span class="text-muted" style="font-size: 0.75rem;">
            Criada em [[ formatDate(company.created_at) ]]
          </span>
          <div class="flex gap-xs">
            <button class="btn btn-icon btn-ghost" title="Editar" @click="openEditModal(company)">
              <i data-lucide="pencil" style="width: 16px; height: 16px;"></i>
            </button>
            <button class="btn btn-icon btn-ghost" title="Excluir" @click="confirmDelete(company)" v-if="user && user.role === 'superadmin'">
              <i data-lucide="trash-2" style="width: 16px; height: 16px;"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <!-- Create/Edit Modal -->
  <div class="modal-overlay" :class="{ active: showModal }" @click.self="closeModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">[[ editingCompany ? 'Editar Empresa' : 'Nova Empresa' ]]</h3>
        <button class="btn btn-icon btn-ghost" @click="closeModal">
          <i data-lucide="x" style="width: 20px; height: 20px;"></i>
        </button>
      </div>
      <div class="modal-body">
        <form @submit.prevent="saveCompany">
          <div class="form-group">
            <label class="form-label">Nome *</label>
            <input type="text" class="form-input" v-model="form.name" required placeholder="Nome da empresa">
          </div>
          
          <div class="form-group">
            <label class="form-label">CNPJ *</label>
            <input type="text" class="form-input" v-model="form.cnpj" required placeholder="00.000.000/0001-00">
          </div>
          
          <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" class="form-input" v-model="form.email" placeholder="email@empresa.com">
          </div>
          
          <div class="form-group">
            <label class="form-label">Telefone</label>
            <input type="text" class="form-input" v-model="form.phone" placeholder="(11) 99999-9999">
          </div>
          
          <div class="form-group">
            <label class="form-label">Endereço</label>
            <textarea class="form-textarea" v-model="form.address" placeholder="Endereço completo" style="min-height: 80px;"></textarea>
          </div>
          
          <div class="form-group" v-if="editingCompany">
            <label class="form-label">Status</label>
            <select class="form-select" v-model="form.is_active">
              <option :value="true">Ativa</option>
              <option :value="false">Inativa</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" @click="closeModal">Cancelar</button>
        <button class="btn btn-primary" @click="saveCompany" :disabled="saving">
          <span v-if="saving" class="spinner"></span>
          <span v-else>[[ editingCompany ? 'Salvar' : 'Criar' ]]</span>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Delete Confirmation Modal -->
  <div class="modal-overlay" :class="{ active: showDeleteModal }" @click.self="showDeleteModal = false">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <h3 class="modal-title">Confirmar exclusão</h3>
        <button class="btn btn-icon btn-ghost" @click="showDeleteModal = false">
          <i data-lucide="x" style="width: 20px; height: 20px;"></i>
        </button>
      </div>
      <div class="modal-body">
        <p>Tem certeza que deseja excluir esta empresa?</p>
        <p class="text-muted" style="margin-top: 8px;">[[ deletingCompany?.name ]]</p>
        <p class="text-danger" style="margin-top: 8px; font-size: 0.875rem;">
          ⚠️ Esta ação também excluirá todas as faturas associadas.
        </p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" @click="showDeleteModal = false">Cancelar</button>
        <button class="btn btn-danger" @click="deleteCompany" :disabled="deleting">
          <span v-if="deleting" class="spinner"></span>
          <span v-else>Excluir</span>
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const { createApp } = Vue;

createApp({
  delimiters: ['[[', ']]'],
  data() {
    return {
      user: null,
      currentPage: 'companies',
      sidebarOpen: false,
      showUserMenu: false,
      companies: [],
      loading: true,
      showModal: false,
      showDeleteModal: false,
      editingCompany: null,
      deletingCompany: null,
      saving: false,
      deleting: false,
      form: {
        name: '',
        cnpj: '',
        email: '',
        phone: '',
        address: '',
        is_active: true
      }
    };
  },
  methods: {
    formatDate(date) {
      return window.formatDate(date);
    },
    async loadCompanies() {
      this.loading = true;
      try {
        this.companies = await api('/api/companies');
      } catch (err) {
        showToast(err.message, 'error');
      } finally {
        this.loading = false;
        this.$nextTick(() => lucide.createIcons());
      }
    },
    openCreateModal() {
      this.editingCompany = null;
      this.form = {
        name: '',
        cnpj: '',
        email: '',
        phone: '',
        address: '',
        is_active: true
      };
      this.showModal = true;
      this.$nextTick(() => lucide.createIcons());
    },
    openEditModal(company) {
      this.editingCompany = company;
      this.form = {
        name: company.name,
        cnpj: company.cnpj,
        email: company.email || '',
        phone: company.phone || '',
        address: company.address || '',
        is_active: company.is_active
      };
      this.showModal = true;
      this.$nextTick(() => lucide.createIcons());
    },
    closeModal() {
      this.showModal = false;
      this.editingCompany = null;
    },
    async saveCompany() {
      this.saving = true;
      try {
        if (this.editingCompany) {
          await api(`/api/companies/${this.editingCompany.id}`, {
            method: 'PUT',
            body: JSON.stringify(this.form)
          });
          showToast('Empresa atualizada com sucesso');
        } else {
          await api('/api/companies', {
            method: 'POST',
            body: JSON.stringify(this.form)
          });
          showToast('Empresa criada com sucesso');
        }
        
        this.closeModal();
        await this.loadCompanies();
      } catch (err) {
        showToast(err.message, 'error');
      } finally {
        this.saving = false;
      }
    },
    confirmDelete(company) {
      this.deletingCompany = company;
      this.showDeleteModal = true;
      this.$nextTick(() => lucide.createIcons());
    },
    async deleteCompany() {
      this.deleting = true;
      try {
        await api(`/api/companies/${this.deletingCompany.id}`, { method: 'DELETE' });
        showToast('Empresa excluída com sucesso');
        this.showDeleteModal = false;
        this.deletingCompany = null;
        await this.loadCompanies();
      } catch (err) {
        showToast(err.message, 'error');
      } finally {
        this.deleting = false;
      }
    },
    toggleUserMenu() {
      this.showUserMenu = !this.showUserMenu;
    },
    logout() {
      localStorage.removeItem('token');
      window.location.href = '/login';
    },
    async loadUser() {
      try {
        this.user = await api('/api/auth/me');
      } catch (err) {
        console.error(err);
      }
    }
  },
  async mounted() {
    if (!localStorage.getItem('token')) {
      window.location.href = '/login';
      return;
    }
    await this.loadUser();
    await this.loadCompanies();
    this.$nextTick(() => lucide.createIcons());
  }
}).mount('#app');
</script>
{% endblock %}
